<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Encrypted Chat - WASM Edition</title>
    <style>
        /* General styles */
        :root {
            --primary-color: #4a6ee0;
            --secondary-color: #6c8ff8;
            --text-color: #333;
            --background-color: #f5f5f5;
            --container-bg: #ffffff;
            --border-color: #e0e0e0;
        }

        /* Dark mode if preferred */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #5d7ce9;
                --secondary-color: #7894fa;
                --text-color: #e0e0e0;
                --background-color: #121212;
                --container-bg: #1e1e1e;
                --border-color: #333;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            background-color: var(--container-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .server-info {
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
            margin-top: 0;
            margin-bottom: 25px;
        }

        .loading {
            text-align: center;
            margin: 40px 0;
            font-style: italic;
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(74, 110, 224, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #app-container {
            min-height: 400px;
        }

        .info-box {
            background-color: rgba(74, 110, 224, 0.1);
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 4px 4px 0;
        }

        .info-box h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.8em;
            color: var(--text-color);
            opacity: 0.7;
        }

        footer a {
            color: var(--primary-color);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>P2P Encrypted Chat</h1>
        <p class="server-info">Connected to: <span id="server-name">coyote.technology</span></p>
        
        <div class="info-box">
            <h3>End-to-End Encrypted Communication</h3>
            <p>This chat application uses WebRTC for direct peer-to-peer connections and AES-256-GCM encryption to secure your messages. Your data never passes through a central server.</p>
        </div>
        
        <div id="app-container">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading WebAssembly chat application...</p>
            </div>
        </div>
        
        <div class="info-box">
            <h3>How It Works</h3>
            <p>When you connect with another user, this application:</p>
            <ol>
                <li>Establishes a direct peer-to-peer connection using WebRTC</li>
                <li>Uses the built-in TURN server for NAT traversal when needed</li>
                <li>Encrypts all messages with strong end-to-end encryption</li>
                <li>Keeps your conversations completely private</li>
            </ol>
        </div>
        
        <footer>
            <p>Powered by Rust & WebAssembly Â· <a href="https://coyote.technology" target="_blank">coyote.technology</a></p>
        </footer>
    </div>

    <script type="module">
        // Update server name
        document.getElementById('server-name').textContent = window.location.hostname;
        
        // Function to load the WASM module
        async function loadWasmChat() {
            try {
                // Import the WASM module
                const { default: init, P2PChat, fetch_turn_config } = await import('/assets/p2p_chat_wasm.js');
                
                // Initialize the WASM module
                await init();
                console.log("WASM module initialized");
                
                // Fetch TURN configuration from the server
                let turnConfig = null;
                try {
                    turnConfig = await fetch_turn_config();
                    console.log("TURN config successfully fetched");
                } catch (e) {
                    console.warn("Could not fetch TURN config:", e);
                }
                
                // Remove loading indicator
                document.querySelector('.loading').remove();
                
                // Create main UI elements
                const appContainer = document.getElementById('app-container');
                appContainer.innerHTML = `
                    <div class="tabs">
                        <div class="tab active" id="tab-chat">Chat</div>
                        <div class="tab" id="tab-connect">Connect</div>
                        <div class="tab" id="tab-debug">Debug</div>
                    </div>
                    
                    <div class="tab-content active" id="content-chat">
                        <div class="status" id="connection-status">Initialized, not connected</div>
                        <div class="messages" id="messages"></div>
                        <div class="input-area">
                            <input type="text" id="message-input" placeholder="Type your message..." disabled>
                            <button id="send-button" disabled>Send</button>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="content-connect">
                        <!-- Connection UI will be added here -->
                    </div>
                    
                    <div class="tab-content" id="content-debug">
                        <!-- Debug UI will be added here -->
                    </div>
                `;
                
                // Initialize chat with the TURN config
                const chat = new P2PChat(turnConfig);
                window.chatInstance = chat;
                
                // Set up the rest of the UI and handlers
                // This would be a lot more code to initialize all the UI elements and event handlers
                // For brevity, we're not including the full initialization here
                
                console.log("Chat application loaded successfully");
            } catch (error) {
                console.error("Failed to load WASM chat:", error);
                const appContainer = document.getElementById('app-container');
                appContainer.innerHTML = `
                    <div style="color: #e74c3c; text-align: center; padding: 20px;">
                        <h3>Error Loading Chat Application</h3>
                        <p>${error.message || "An unknown error occurred"}</p>
                        <p>Please try refreshing the page or check if your browser supports WebAssembly.</p>
                    </div>
                `;
            }
        }
        
        // Load the WASM chat when the page is ready
        document.addEventListener('DOMContentLoaded', loadWasmChat);
    </script>
</body>
</html>
